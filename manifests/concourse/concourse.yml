# Concourse deployment manifest for BOSH lab
# Single-VM deployment for developer laptops.
# All jobs co-located on one instance for simplicity.

name: ((deployment_name))

releases:
  - name: concourse
    version: latest
  - name: bpm
    version: latest
  - name: postgres
    version: latest

stemcells:
  - alias: default
    os: ubuntu-jammy
    version: latest

instance_groups:
  - name: concourse
    instances: 1
    azs: [z1]
    vm_type: ((web_vm_type))
    stemcell: default
    # Note: persistent_disk_type removed â€” losetup fails in nested containers.
    # Postgres uses ephemeral storage. Data survives container restarts but
    # not VM recreation. Acceptable for a developer lab.
    networks:
      - name: ((network_name))
        static_ips:
          - ((web_ip))
    jobs:
      - name: bpm
        release: bpm
      - name: postgres
        release: postgres
        properties:
          databases:
            port: 5432
            databases:
              - name: atc
            roles:
              - name: concourse
                password: ((postgres_password))
      - name: web
        release: concourse
        properties:
          external_url: ((external_url))
          token_signing_key: ((token_signing_key))
          bind_port: 8080
          postgresql:
            host: 127.0.0.1
            database: atc
            role:
              name: concourse
              password: ((postgres_password))
          add_local_users:
            - admin:((admin_password))
          main_team:
            auth:
              local:
                users:
                  - admin
          worker_gateway:
            host_key: ((tsa_host_key))
            authorized_keys:
              - ((worker_key.public_key))
      - name: worker
        release: concourse
        properties:
          drain_timeout: 10m
          worker_gateway:
            host: 127.0.0.1
            host_public_key: ((tsa_host_key.public_key))
            worker_key: ((worker_key))

update:
  canaries: 1
  max_in_flight: 1
  serial: false
  canary_watch_time: 1000-60000
  update_watch_time: 1000-60000

variables:
  - name: postgres_password
    type: password
  - name: admin_password
    type: password
  - name: token_signing_key
    type: rsa
  - name: tsa_host_key
    type: ssh
  - name: worker_key
    type: ssh
